<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CATY Sensitivity Lab | NIM vs EPS & TBVPS</title>
    <link rel="stylesheet" href="assets/css/sensitivity_viz.css">
    <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
</head>
<body class="sensitivity-page">
<main>
    <header class="page-header" aria-label="Page header">
        <a href="index.html" class="filter-chip" style="text-decoration:none;" aria-label="Back to dashboard">← All modules</a>
    </header>

    <section class="headline-callout" aria-live="polite">
        <strong>50 bps NIM swing = <span id="headline-variation">62%</span> EPS range</strong>
        From $0.79 to $1.49 under extreme scenarios (-50 bps/-2% loans → +50 bps/+2% loans)
    </section>

    <section class="chart-grid">
        <article class="chart-card" aria-labelledby="eps-chart-heading">
            <h2 id="eps-chart-heading">EPS Sensitivity</h2>
            <p class="chart-subtitle">Quarterly EPS response to ±50 bps NIM shifts under alternative loan growth paths.</p>
            <div class="chart-toolbar" role="toolbar" aria-label="Scenario visibility toggles">
                <span class="sr-only" id="scenario-toggle-instructions">Press Enter to toggle loan growth scenarios.</span>
                <button type="button" class="filter-chip" data-scenario="-2%" aria-pressed="true" aria-describedby="scenario-toggle-instructions">-2% loans</button>
                <button type="button" class="filter-chip" data-scenario="0%" aria-pressed="true" aria-describedby="scenario-toggle-instructions">0% loans</button>
                <button type="button" class="filter-chip" data-scenario="+2%" aria-pressed="true" aria-describedby="scenario-toggle-instructions">+2% loans</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="epsChart" role="img" aria-label="EPS sensitivity to NIM changes chart"></canvas>
            </div>
            <p class="chart-footnote">Baseline EPS $1.13 at 0 bps NIM delta and flat loans. Annotations show worst and best cases versus baseline.</p>
        </article>

        <article class="chart-card" aria-labelledby="tbvps-chart-heading">
            <h2 id="tbvps-chart-heading">TBVPS Sensitivity</h2>
            <p class="chart-subtitle">Tangible book value per share (TBVPS) response to ±50 bps NIM shifts under alternative loan growth paths.</p>
            <div class="chart-toolbar" role="toolbar" aria-label="Scenario visibility toggles (mirrors EPS chart)">
                <span class="sr-only" id="scenario-toggle-instructions-tbvps">Press Enter to toggle loan growth scenarios.</span>
                <button type="button" class="filter-chip" data-scenario="-2%" aria-pressed="true" aria-describedby="scenario-toggle-instructions-tbvps">-2% loans</button>
                <button type="button" class="filter-chip" data-scenario="0%" aria-pressed="true" aria-describedby="scenario-toggle-instructions-tbvps">0% loans</button>
                <button type="button" class="filter-chip" data-scenario="+2%" aria-pressed="true" aria-describedby="scenario-toggle-instructions-tbvps">+2% loans</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="tbvpsChart" role="img" aria-label="TBVPS sensitivity to NIM changes chart"></canvas>
            </div>
            <p class="chart-footnote">Baseline TBVPS $41.00 at 0 bps NIM delta and flat loans. Worst/best callouts quantify per-share delta versus baseline.</p>
        </article>
    </section>

    <section class="data-table-container" aria-labelledby="table-heading">
        <h3 id="table-heading">Integrated Sensitivity Table</h3>
        <p>Exact model outputs across the NIM shock grid. Values rounded to two decimal places.</p>
        <div class="table-wrapper" role="region" aria-live="polite">
            <table class="sensitivity-table" id="sensitivityTable">
                <thead>
                    <tr>
                        <th scope="col">Δ NIM (bps)</th>
                        <th scope="col">EPS (-2%)</th>
                        <th scope="col">EPS (0%)</th>
                        <th scope="col">EPS (+2%)</th>
                        <th scope="col">TBVPS (-2%)</th>
                        <th scope="col">TBVPS (0%)</th>
                        <th scope="col">TBVPS (+2%)</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <div class="export-actions" role="group" aria-label="Export options">
            <button type="button" class="export-button" id="exportPng">
                Export charts (PNG)
            </button>
            <button type="button" class="export-button" id="exportCsv">
                Export table (CSV)
            </button>
        </div>
        <details class="data-fallback">
            <summary>Keyboard / screen reader data view</summary>
            <p>The table above mirrors data from <code>data/sensitivity_table.json</code>. Use the CSV export for downstream analysis.</p>
        </details>
    </section>

    <section class="footnotes" aria-label="Methodology footnotes">
        <p><strong>Method</strong>: First-order bridge. EPS = (IEA × NIM / 4 × (1 - tax)) ÷ shares + non-interest contribution. TBVPS effect = EPS × (1 - payout) versus baseline.</p>
        <p><strong>Data vintage</strong>: Oct 22 2025 &nbsp;|&nbsp; Source: CATY 10-Q Q2 2025 &nbsp;|&nbsp; Baseline: EPS $1.13, TBVPS $41.00, NIM 3.31%, IEA $22.0B, shares 68.7M.</p>
    </section>
</main>

<script>
const FALLBACK_SENSITIVITY_DATA = [
    {"delta_nim_bps": -50, "loan_growth": "-2%", "eps": 0.79, "tbvps": 40.77},
    {"delta_nim_bps": -50, "loan_growth": "0%", "eps": 0.82, "tbvps": 40.79},
    {"delta_nim_bps": -50, "loan_growth": "+2%", "eps": 0.86, "tbvps": 40.81},
    {"delta_nim_bps": -25, "loan_growth": "-2%", "eps": 0.94, "tbvps": 40.87},
    {"delta_nim_bps": -25, "loan_growth": "0%", "eps": 0.98, "tbvps": 40.90},
    {"delta_nim_bps": -25, "loan_growth": "+2%", "eps": 1.01, "tbvps": 40.92},
    {"delta_nim_bps": 0, "loan_growth": "-2%", "eps": 1.09, "tbvps": 40.97},
    {"delta_nim_bps": 0, "loan_growth": "0%", "eps": 1.13, "tbvps": 41.00},
    {"delta_nim_bps": 0, "loan_growth": "+2%", "eps": 1.17, "tbvps": 41.03},
    {"delta_nim_bps": 25, "loan_growth": "-2%", "eps": 1.24, "tbvps": 41.07},
    {"delta_nim_bps": 25, "loan_growth": "0%", "eps": 1.28, "tbvps": 41.10},
    {"delta_nim_bps": 25, "loan_growth": "+2%", "eps": 1.33, "tbvps": 41.13},
    {"delta_nim_bps": 50, "loan_growth": "-2%", "eps": 1.39, "tbvps": 41.18},
    {"delta_nim_bps": 50, "loan_growth": "0%", "eps": 1.44, "tbvps": 41.21},
    {"delta_nim_bps": 50, "loan_growth": "+2%", "eps": 1.49, "tbvps": 41.24}
];

const SCENARIO_COLORS = {
    "-2%": "#8C1E33",  // canonical --danger (down/worst)
    "0%": "#4F5B67",   // canonical --bar-neutral
    "+2%": "#2E6F3E"   // canonical --success (up/best)
};

const NIM_LABELS = ["-50", "-25", "0", "+25", "+50"];
const SCENARIOS = ["-2%", "0%", "+2%"];
const EPS_BASELINE = 1.13;
const TBVPS_BASELINE = 41.00;

const directLabelPlugin = {
    id: "directLabel",
    afterDatasetsDraw(chart, args, pluginOptions) {
        const { ctx } = chart;
        chart.data.datasets.forEach((dataset, datasetIndex) => {
            if (!chart.isDatasetVisible(datasetIndex)) {
                return;
            }
            const meta = chart.getDatasetMeta(datasetIndex);
            if (!meta || !meta.data || !meta.data.length) {
                return;
            }
            const el = meta.data[meta.data.length - 1];
            if (!el) {
                return;
            }
            const { x, y } = el.tooltipPosition();
            const labelText = typeof pluginOptions.formatter === "function"
                ? pluginOptions.formatter(dataset)
                : dataset.label;
            ctx.save();
            ctx.font = "600 12px Inter, system-ui, -apple-system, BlinkMacSystemFont, sans-serif";
            ctx.fillStyle = dataset.borderColor;
            ctx.textAlign = "left";
            ctx.textBaseline = "middle";
            ctx.fillText(labelText, x + 12, y);
            ctx.restore();
        });
    }
};

const annotationPlugin = window["chartjs-plugin-annotation"];
if (annotationPlugin) {
    Chart.register(annotationPlugin);
}
Chart.register(directLabelPlugin);

async function loadSensitivityData() {
    try {
        const response = await fetch("data/sensitivity_table.json");
        if (!response.ok) {
            throw new Error("Failed to load data");
        }
        return await response.json();
    } catch (error) {
        console.warn("Falling back to embedded sensitivity data:", error);
        return FALLBACK_SENSITIVITY_DATA;
    }
}

function groupByScenario(data, key) {
    return SCENARIOS.map((scenario) => {
        const scenarioPoints = NIM_LABELS.map((label) => {
            const nim = parseInt(label.replace("+", ""), 10);
            const row = data.find(
                (entry) => entry.delta_nim_bps === nim && entry.loan_growth === scenario
            );
            return {
                x: label,
                y: parseFloat(row[key])
            };
        });
        return {
            label: `${scenario} loans`,
            scenario,
            data: scenarioPoints,
            borderColor: SCENARIO_COLORS[scenario],
            backgroundColor: SCENARIO_COLORS[scenario],
            tension: 0.35,
            borderWidth: 3,
            pointRadius: 4,
            pointHoverRadius: 6
        };
    });
}

function formatCurrency(value) {
    return `$${value.toFixed(2)}`;
}

function buildTable(data) {
    const tbody = document.querySelector("#sensitivityTable tbody");
    tbody.innerHTML = "";
    NIM_LABELS.forEach((label) => {
        const nim = parseInt(label.replace("+", ""), 10);
        const rowData = data.filter((entry) => entry.delta_nim_bps === nim);
        const tr = document.createElement("tr");
        const deltaCell = document.createElement("td");
        deltaCell.textContent = `${label}`;
        tr.appendChild(deltaCell);

        SCENARIOS.forEach((scenario) => {
            const scenarioRow = rowData.find((entry) => entry.loan_growth === scenario);
            const epsCell = document.createElement("td");
            epsCell.textContent = formatCurrency(scenarioRow.eps);
            tr.appendChild(epsCell);
        });

        SCENARIOS.forEach((scenario) => {
            const scenarioRow = rowData.find((entry) => entry.loan_growth === scenario);
            const tbvpsCell = document.createElement("td");
            tbvpsCell.textContent = formatCurrency(scenarioRow.tbvps);
            tr.appendChild(tbvpsCell);
        });

        tbody.appendChild(tr);
    });
}

function computeHeadline(data) {
    const epsValues = data.map((entry) => entry.eps);
    const epsMin = Math.min(...epsValues);
    const epsMax = Math.max(...epsValues);
    const variationPct = ((epsMax - epsMin) / EPS_BASELINE) * 100;
    document.getElementById("headline-variation").textContent = `${Math.round(variationPct)}%`;
}

function prepareAnnotations(type) {
    if (type === "EPS") {
        return {
            baseline: {
                type: "line",
                yMin: EPS_BASELINE,
                yMax: EPS_BASELINE,
                borderColor: "#6b7280",
                borderWidth: 1.5,
                borderDash: [6, 6],
                label: {
                    enabled: true,
                    position: "start",
                    backgroundColor: "rgba(107,114,128,0.8)",
                    content: ["Baseline $1.13"],
                    color: "#ffffff",
                    font: { size: 11, weight: "600" },
                    padding: 6
                }
            },
            worst: {
                type: "label",
                xValue: "-50",
                yValue: 0.79,
                backgroundColor: "rgba(185,28,28,0.12)",
                borderColor: "#b91c1c",
                borderWidth: 1,
                content: ["Worst case:", "-30% vs baseline"],
                font: { size: 11, weight: "600" },
                color: "#b91c1c",
                position: { x: "center", y: "bottom" },
                padding: 8,
                callout: {
                    enabled: true,
                    borderColor: "#b91c1c",
                    borderWidth: 1,
                    arrowHeadSize: 6,
                    position: "center",
                    side: "bottom"
                }
            },
            best: {
                type: "label",
                xValue: "+50",
                yValue: 1.49,
                backgroundColor: "rgba(6,95,70,0.12)",
                borderColor: "#065f46",
                borderWidth: 1,
                content: ["Best case:", "+32% vs baseline"],
                font: { size: 11, weight: "600" },
                color: "#065f46",
                position: { x: "center", y: "top" },
                padding: 8,
                callout: {
                    enabled: true,
                    borderColor: "#065f46",
                    borderWidth: 1,
                    arrowHeadSize: 6,
                    position: "center",
                    side: "top"
                }
            }
        };
    }
    return {
        baseline: {
            type: "line",
            yMin: TBVPS_BASELINE,
            yMax: TBVPS_BASELINE,
            borderColor: "#6b7280",
            borderWidth: 1.5,
            borderDash: [6, 6],
            label: {
                enabled: true,
                position: "start",
                backgroundColor: "rgba(107,114,128,0.8)",
                content: ["Baseline $41.00"],
                color: "#ffffff",
                font: { size: 11, weight: "600" },
                padding: 6
            }
        },
        worst: {
            type: "label",
            xValue: "-50",
            yValue: 40.77,
            backgroundColor: "rgba(185,28,28,0.12)",
            borderColor: "#b91c1c",
            borderWidth: 1,
            content: ["Worst case:", "-$0.23 vs baseline"],
            font: { size: 11, weight: "600" },
            color: "#b91c1c",
            position: { x: "center", y: "bottom" },
            padding: 8,
            callout: {
                enabled: true,
                borderColor: "#b91c1c",
                borderWidth: 1,
                arrowHeadSize: 6,
                position: "center",
                side: "bottom"
            }
        },
        best: {
            type: "label",
            xValue: "+50",
            yValue: 41.24,
            backgroundColor: "rgba(6,95,70,0.12)",
            borderColor: "#065f46",
            borderWidth: 1,
            content: ["Best case:", "+$0.24 vs baseline"],
            font: { size: 11, weight: "600" },
            color: "#065f46",
            position: { x: "center", y: "top" },
            padding: 8,
            callout: {
                enabled: true,
                borderColor: "#065f46",
                borderWidth: 1,
                arrowHeadSize: 6,
                position: "center",
                side: "top"
            }
        }
    };
}

function sharedChartOptions(yTitle, yMin, yMax, step, formatter, annotations, labelFormatter) {
    return {
        responsive: true,
        maintainAspectRatio: false,
        layout: {
            padding: {
                right: 90
            }
        },
        scales: {
            x: {
                type: "category",
                labels: NIM_LABELS,
                grid: {
                    color: "rgba(148, 163, 184, 0.2)",
                    drawBorder: false
                },
                ticks: {
                    color: "#1f2937",
                    font: { size: 12 }
                },
                title: {
                    display: true,
                    text: "Δ NIM (bps)",
                    font: { weight: "600", size: 12 },
                    color: "#1f2937"
                }
            },
            y: {
                min: yMin,
                max: yMax,
                grid: {
                    color: "rgba(148, 163, 184, 0.15)",
                    drawBorder: false
                },
                ticks: {
                    stepSize: step,
                    color: "#1f2937",
                    font: { size: 12 },
                    callback: formatter
                },
                title: {
                    display: true,
                    text: yTitle,
                    font: { weight: "600", size: 12 },
                    color: "#1f2937"
                }
            }
        },
        interaction: {
            mode: "index",
            intersect: false
        },
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: "rgba(15, 23, 42, 0.92)",
                borderRadius: 8,
                padding: 12,
                callbacks: {
                    title: (items) => `Δ NIM: ${items[0].label}`,
                    label: (context) => `${context.dataset.scenario} loans: ${formatter(context.parsed.y)}`
                }
            },
            annotation: {
                annotations
            },
            directLabel: {
                formatter: labelFormatter
            }
        }
    };
}

function toggleScenarioVisibility(charts, scenario, buttons) {
    charts.forEach((chart) => {
        const datasetIndex = chart.data.datasets.findIndex((dataset) => dataset.scenario === scenario);
        if (datasetIndex === -1) {
            return;
        }
        const isVisible = chart.isDatasetVisible(datasetIndex);
        chart.setDatasetVisibility(datasetIndex, !isVisible);
        chart.update();
    });

    buttons.forEach((btn) => {
        if (btn.dataset.scenario === scenario) {
            const pressed = btn.getAttribute("aria-pressed") === "true";
            btn.setAttribute("aria-pressed", String(!pressed));
        }
    });
}

function syncHover(sourceChart, targetChart, event) {
    const points = sourceChart.getElementsAtEventForMode(event, "index", { intersect: false }, false);
    if (points.length) {
        const { index } = points[0];
        const active = targetChart.getSortedVisibleDatasetMetas().map((meta) => ({
            datasetIndex: meta.index,
            index
        }));
        targetChart.tooltip.setActiveElements(active, {
            x: targetChart.scales.x.getPixelForValue(targetChart.data.labels[index]),
            y: targetChart.scales.y.top
        });
        targetChart.update("none");
    } else {
        targetChart.tooltip.setActiveElements([], { x: 0, y: 0 });
        targetChart.update("none");
    }
}

function setupHoverSync(epsChart, tbvpsChart) {
    const epsCanvas = epsChart.canvas;
    const tbvpsCanvas = tbvpsChart.canvas;

    epsCanvas.addEventListener("mousemove", (event) => syncHover(epsChart, tbvpsChart, event));
    epsCanvas.addEventListener("mouseout", () => {
        tbvpsChart.tooltip.setActiveElements([], { x: 0, y: 0 });
        tbvpsChart.update("none");
    });

    tbvpsCanvas.addEventListener("mousemove", (event) => syncHover(tbvpsChart, epsChart, event));
    tbvpsCanvas.addEventListener("mouseout", () => {
        epsChart.tooltip.setActiveElements([], { x: 0, y: 0 });
        epsChart.update("none");
    });
}

function exportChartsAsPng(charts) {
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    const width = charts.reduce((acc, chart) => acc + chart.width, 0);
    const height = Math.max(...charts.map((chart) => chart.height));
    canvas.width = width;
    canvas.height = height;

    let offsetX = 0;
    charts.forEach((chart) => {
        ctx.drawImage(chart.canvas, offsetX, 0);
        offsetX += chart.width;
    });

    const link = document.createElement("a");
    link.href = canvas.toDataURL("image/png");
    link.download = "caty_nim_sensitivity.png";
    link.click();
}

function exportTableAsCsv(data) {
    const headers = [
        "delta_nim_bps",
        "loan_growth",
        "eps",
        "tbvps"
    ];
    const rows = data.map((row) => headers.map((header) => row[header]));
    const csvContent = [
        headers.join(","),
        ...rows.map((row) => row.join(","))
    ].join("\n");

    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = "caty_nim_sensitivity.csv";
    link.click();
    URL.revokeObjectURL(url);
}

document.addEventListener("DOMContentLoaded", async () => {
    const data = await loadSensitivityData();
    computeHeadline(data);
    buildTable(data);

    const epsDatasets = groupByScenario(data, "eps");
    const tbvpsDatasets = groupByScenario(data, "tbvps");

    const epsChart = new Chart(
        document.getElementById("epsChart"),
        {
            type: "line",
            data: {
                labels: NIM_LABELS,
                datasets: epsDatasets
            },
            options: sharedChartOptions(
                "EPS (USD/share)",
                0.75,
                1.55,
                0.25,
                (value) => formatCurrency(value),
                prepareAnnotations("EPS"),
                (dataset) => {
                    const lastPoint = dataset.data[dataset.data.length - 1];
                    return `${dataset.scenario} loans: ${formatCurrency(lastPoint.y)}`;
                }
            )
        }
    );

    const tbvpsChart = new Chart(
        document.getElementById("tbvpsChart"),
        {
            type: "line",
            data: {
                labels: NIM_LABELS,
                datasets: tbvpsDatasets
            },
            options: sharedChartOptions(
                "TBVPS (USD/share)",
                40.7,
                41.3,
                0.2,
                (value) => formatCurrency(value),
                prepareAnnotations("TBVPS"),
                (dataset) => {
                    const lastPoint = dataset.data[dataset.data.length - 1];
                    return `${dataset.scenario} loans: ${formatCurrency(lastPoint.y)}`;
                }
            )
        }
    );

    setupHoverSync(epsChart, tbvpsChart);

    const toggleButtons = Array.from(document.querySelectorAll('.chart-toolbar .filter-chip'));
    toggleButtons.forEach((button) => {
        button.addEventListener("click", () => {
            const scenario = button.dataset.scenario;
            toggleScenarioVisibility([epsChart, tbvpsChart], scenario, toggleButtons.filter((btn) => btn.dataset.scenario === scenario));
        });
        button.addEventListener("keyup", (event) => {
            if (event.key === "Enter" || event.key === " ") {
                event.preventDefault();
                button.click();
            }
        });
    });

    document.getElementById("exportPng").addEventListener("click", () => exportChartsAsPng([epsChart, tbvpsChart]));
    document.getElementById("exportCsv").addEventListener("click", () => exportTableAsCsv(data));
});
</script>
</body>
</html>
